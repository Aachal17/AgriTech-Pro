<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Agri Dashboard</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet.js CDN for Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f3f4f6;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark-mode {
      background-color: #1a202c;
      color: #e2e8f0;
    }
    .dark-mode .sensor-card, .dark-mode .pump-card, .dark-mode .bg-white {
      background-color: #2d3748;
      color: #e2e8f0;
    }
    .sensor-card, .pump-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 16px;
      transition: transform 0.2s, background-color 0.3s, color 0.3s;
    }
    .sensor-card:hover, .pump-card:hover {
      transform: scale(1.02);
    }
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }
    #notifications {
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 350px;
      z-index: 1000;
    }
    .notification {
      background: #fff;
      border: 1px solid #ddd;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      transition: background-color 0.3s;
    }
    .dark-mode .notification {
      background: #2d3748;
      border-color: #4a5568;
    }
    .log-entry {
      padding: 8px;
      border-bottom: 1px solid #eee;
      font-size: 12px;
    }
    .dark-mode .log-entry {
      border-bottom-color: #4a5568;
    }
    #log-container {
      max-height: 300px;
      overflow-y: auto;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      max-width: 400px;
      text-align: center;
      transition: background-color 0.3s;
    }
    .dark-mode .modal-content {
      background: #2d3748;
    }
    #cow-map {
      height: 500px;
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <!-- Container -->
  <div class="flex flex-col md:flex-row min-h-screen">
    <!-- Sidebar -->
    <aside class="w-full md:w-64 bg-green-800 text-white p-4">
      <h1 class="text-2xl font-bold">Advanced Agri Dashboard</h1>
      <nav class="mt-6">
        <ul>
          <li class="py-2 cursor-pointer hover:bg-green-700" onclick="showSection('home')">Home</li>
          <li class="py-2 cursor-pointer hover:bg-green-700" onclick="showSection('sensors')">Sensors</li>
          <li class="py-2 cursor-pointer hover:bg-green-700" onclick="togglePumpForm()">Add Motor Pump</li>
          <li class="py-2 cursor-pointer hover:bg-green-700" onclick="toggleAssistant()">AI Plant Doctor</li>
          <li class="py-2 cursor-pointer hover:bg-green-700" onclick="showSection('cow-tracking')">Cow Tracking</li>
          <li class="py-2 cursor-pointer hover:bg-green-700" onclick="showSection('performance')">Performance</li>
          <li class="py-2 cursor-pointer hover:bg-green-700" onclick="showSection('logs')">Logs</li>
          <li class="py-2 cursor-pointer hover:bg-green-700" onclick="showSection('settings')">Settings</li>
        </ul>
      </nav>
      <div class="mt-4 text-sm">
        <p>Location: <span id="location" class="font-semibold">Fetching...</span></p>
        <button onclick="toggleDarkMode()" class="mt-2 bg-gray-600 text-white p-2 rounded hover:bg-gray-700 w-full">Toggle Dark Mode</button>
      </div>
      <!-- AI Assistant Section -->
      <div id="assistant-section" class="hidden mt-4">
        <h3 class="text-lg font-semibold">AI Plant Doctor</h3>
        <textarea id="symptoms" rows="4" placeholder="Describe plant symptoms (e.g., yellow leaves, wilting, severity: mild/severe)" class="w-full p-2 mt-2 border rounded text-black"></textarea>
        <button onclick="diagnosePlant()" class="mt-2 bg-blue-600 text-white p-2 rounded hover:bg-blue-700 w-full">Diagnose</button>
        <div id="diagnosis-history" class="mt-4 max-h-40 overflow-y-auto text-sm"></div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6">
      <header class="flex justify-between items-center mb-6">
        <h2 id="section-title" class="text-xl font-semibold text-gray-800">Dashboard Overview</h2>
        <div class="flex items-center">
          <label class="mr-2 text-sm text-gray-600">Critical Alerts Only:</label>
          <input type="checkbox" id="critical-only" class="mr-4" onchange="filterNotifications()" />
          <span id="current-time" class="text-sm text-gray-600"></span>
        </div>
      </header>

      <!-- Home Section -->
      <div id="home-section" class="section">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
          <div class="sensor-card">
            <div class="flex justify-between items-center">
              <h3 class="text-lg font-semibold text-gray-800">Temperature</h3>
              <span id="temp-status" class="status-dot"></span>
            </div>
            <p id="temp-value" class="text-3xl font-bold text-gray-800 mt-2">-- °C</p>
            <canvas id="temp-chart" class="mt-4"></canvas>
          </div>
          <div class="sensor-card">
            <div class="flex justify-between items-center">
              <h3 class="text-lg font-semibold text-gray-800">Air Humidity</h3>
              <span id="humid-status" class="status-dot"></span>
            </div>
            <p id="humid-value" class="text-3xl font-bold text-gray-800 mt-2">-- %</p>
            <canvas id="humid-chart" class="mt-4"></canvas>
          </div>
          <div class="sensor-card">
            <div class="flex justify-between items-center">
              <h3 class="text-lg font-semibold text-gray-800">Soil Moisture</h3>
              <span id="soil-status" class="status-dot"></span>
            </div>
            <p id="soil-value" class="text-3xl font-bold text-gray-800 mt-2">-- %</p>
            <canvas id="soil-chart" class="mt-4"></canvas>
          </div>
          <div class="sensor-card">
            <div class="flex justify-between items-center">
              <h3 class="text-lg font-semibold text-gray-800">Air Quality</h3>
              <span id="air-status" class="status-dot"></span>
            </div>
            <p id="air-value" class="text-3xl font-bold text-gray-800 mt-2">-- ppm</p>
            <canvas id="air-chart" class="mt-4"></canvas>
          </div>
        </div>

        <!-- Motor Pumps Section -->
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Motor Pumps</h2>
        <div id="pump-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6"></div>

        <!-- Add Pump Form -->
        <div id="pump-form" class="hidden bg-white p-4 rounded-lg shadow-md mb-6">
          <h3 class="text-lg font-semibold mb-2">Add Motor Pump</h3>
          <input id="pump-name" type="text" placeholder="Pump Name" class="w-full p-2 border rounded mb-2" />
          <button onclick="addPump()" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">Add Pump</button>
          <button onclick="togglePumpForm()" class="bg-gray-600 text-white p-2 rounded hover:bg-gray-700 ml-2">Cancel</button>
        </div>

        <!-- Rain Alert -->
        <div id="rain-alert" class="hidden bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-6">
          <p class="text-yellow-700 font-semibold">Rain Alert: Possible rain detected!</p>
        </div>
      </div>

      <!-- Sensors Section -->
      <div id="sensors-section" class="section hidden">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Detailed Sensor Data</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="sensor-card">
            <h3 class="text-lg font-semibold">Temperature (°C)</h3>
            <canvas id="temp-detail-chart" class="mt-4"></canvas>
            <button onclick="exportChartData('tempDetail')" class="mt-2 bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Export Data</button>
          </div>
          <div class="sensor-card">
            <h3 class="text-lg font-semibold">Air Humidity (%)</h3>
            <canvas id="humid-detail-chart" class="mt-4"></canvas>
            <button onclick="exportChartData('humidDetail')" class="mt-2 bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Export Data</button>
          </div>
          <div class="sensor-card">
            <h3 class="text-lg font-semibold">Soil Moisture (%)</h3>
            <canvas id="soil-detail-chart" class="mt-4"></canvas>
            <button onclick="exportChartData('soilDetail')" class="mt-2 bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Export Data</button>
          </div>
          <div class="sensor-card">
            <h3 class="text-lg font-semibold">Air Quality (ppm)</h3>
            <canvas id="air-detail-chart" class="mt-4"></canvas>
            <button onclick="exportChartData('airDetail')" class="mt-2 bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Export Data</button>
          </div>
        </div>
      </div>

      <!-- Cow Tracking Section -->
      <div id="cow-tracking-section" class="section hidden">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Cow Location Tracking</h2>
        <div id="cow-map" class="mb-6"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-2">Tracked Cows</h3>
            <ul id="cow-list-items" class="list-disc pl-5"></ul>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-2">Manage Cows</h3>
            <input id="cow-id" type="text" placeholder="Cow ID" class="w-full p-2 border rounded mb-2" />
            <input id="cow-lat" type="number" step="0.0001" placeholder="Latitude" class="w-full p-2 border rounded mb-2" />
            <input id="cow-lng" type="number" step="0.0001" placeholder="Longitude" class="w-full p-2 border rounded mb-2" />
            <select id="cow-health" class="w-full p-2 border rounded mb-2">
              <option value="healthy">Healthy</option>
              <option value="sick">Sick</option>
              <option value="injured">Injured</option>
            </select>
            <button onclick="addCow()" class="bg-green-600 text-white p-2 rounded hover:bg-green-700 w-full mb-2">Add Cow</button>
            <button onclick="deleteSelectedCow()" class="bg-red-600 text-white p-2 rounded hover:bg-red-700 w-full">Delete Selected</button>
          </div>
        </div>
      </div>

      <!-- Performance Section -->
      <div id="performance-section" class="section hidden">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">System Performance</h2>
        <div class="bg-white p-4 rounded-lg shadow-md">
          <p>Uptime: <span id="uptime">0s</span></p>
          <p>Memory Usage (Simulated): <span id="memory-usage">0 MB</span></p>
          <p>Notifications Sent: <span id="notification-count">0</span></p>
          <p>Cows Tracked: <span id="cow-count">0</span></p>
          <button onclick="exportAllData()" class="mt-4 bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Export All Data</button>
        </div>
      </div>

      <!-- Logs Section -->
      <div id="logs-section" class="section hidden">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">System Logs</h2>
        <div id="log-container" class="bg-white p-4 rounded-lg shadow-md"></div>
        <button onclick="exportLogs()" class="mt-4 bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Export Logs</button>
      </div>

      <!-- Settings Section -->
      <div id="settings-section" class="section hidden">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Settings</h2>
        <div class="bg-white p-4 rounded-lg shadow-md">
          <h3 class="text-lg font-semibold mb-2">Threshold Adjustments</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm">Temperature Min (°C)</label>
              <input id="temp-min" type="number" class="w-full p-2 border rounded" value="15" />
            </div>
            <div>
              <label class="block text-sm">Temperature Max (°C)</label>
              <input id="temp-max" type="number" class="w-full p-2 border rounded" value="30" />
            </div>
            <div>
              <label class="block text-sm">Humidity Min (%)</label>
              <input id="humid-min" type="number" class="w-full p-2 border rounded" value="40" />
            </div>
            <div>
              <label class="block text-sm">Humidity Max (%)</label>
              <input id="humid-max" type="number" class="w-full p-2 border rounded" value="80" />
            </div>
            <div>
              <label class="block text-sm">Soil Moisture Min (%)</label>
              <input id="soil-min" type="number" class="w-full p-2 border rounded" value="30" />
            </div>
            <div>
              <label class="block text-sm">Soil Moisture Max (%)</label>
              <input id="soil-max" type="number" class="w-full p-2 border rounded" value="80" />
            </div>
            <div>
              <label class="block text-sm">Air Quality Min (ppm)</label>
              <input id="air-min" type="number" class="w-full p-2 border rounded" value="50" />
            </div>
            <div>
              <label class="block text-sm">Air Quality Max (ppm)</label>
              <input id="air-max" type="number" class="w-full p-2 border rounded" value="100" />
            </div>
          </div>
          <h3 class="text-lg font-semibold mt-4 mb-2">Map Settings</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm">Map Center Latitude</label>
              <input id="map-lat" type="number" step="0.0001" class="w-full p-2 border rounded" value="51.505" />
            </div>
            <div>
              <label class="block text-sm">Map Center Longitude</label>
              <input id="map-lng" type="number" step="0.0001" class="w-full p-2 border rounded" value="-0.09" />
            </div>
            <div>
              <label class="block text-sm">Geofence Radius (km)</label>
              <input id="geofence-radius" type="number" step="0.1" class="w-full p-2 border rounded" value="0.5" />
            </div>
          </div>
          <button onclick="saveSettings()" class="mt-4 bg-green-600 text-white p-2 rounded hover:bg-green-700">Save Settings</button>
        </div>
      </div>
    </main>

    <!-- Notifications Panel -->
    <div id="notifications"></div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
      <div class="modal-content">
        <h3 class="text-lg font-semibold mb-4">Confirm Action</h3>
        <p id="confirm-message" class="mb-4"></p>
        <button id="confirm-yes" class="bg-red-600 text-white p-2 rounded hover:bg-red-700 mr-2">Yes</button>
        <button onclick="hideModal()" class="bg-gray-600 text-white p-2 rounded hover:bg-gray-700">No</button>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // ---- Chart Initialization ----
    const charts = {
      temp: new Chart(document.getElementById("temp-chart"), {
        type: "line",
        data: { labels: [], datasets: [{ label: "Temperature (°C)", data: [], borderColor: "#4CAF50", fill: true, backgroundColor: "rgba(76, 175, 80, 0.2)" }] },
        options: { scales: { x: { type: "time", time: { unit: "second" } }, y: { min: 0, max: 40 } }, plugins: { legend: { display: false } }, interaction: { mode: 'index', intersect: false }, responsive: true },
      }),
      humid: new Chart(document.getElementById("humid-chart"), {
        type: "line",
        data: { labels: [], datasets: [{ label: "Humidity (%)", data: [], borderColor: "#2196F3", fill: true, backgroundColor: "rgba(33, 150, 243, 0.2)" }] },
        options: { scales: { x: { type: "time", time: { unit: "second" } }, y: { min: 0, max: 100 } }, plugins: { legend: { display: false } }, interaction: { mode: 'index', intersect: false }, responsive: true },
      }),
      soil: new Chart(document.getElementById("soil-chart"), {
        type: "line",
        data: { labels: [], datasets: [{ label: "Soil Moisture (%)", data: [], borderColor: "#8D5524", fill: true, backgroundColor: "rgba(141, 85, 36, 0.2)" }] },
        options: { scales: { x: { type: "time", time: { unit: "second" } }, y: { min: 0, max: 100 } }, plugins: { legend: { display: false } }, interaction: { mode: 'index', intersect: false }, responsive: true },
      }),
      air: new Chart(document.getElementById("air-chart"), {
        type: "line",
        data: { labels: [], datasets: [{ label: "Air Quality (ppm)", data: [], borderColor: "#F44336", fill: true, backgroundColor: "rgba(244, 67, 54, 0.2)" }] },
        options: { scales: { x: { type: "time", time: { unit: "second" } }, y: { min: 0, max: 200 } }, plugins: { legend: { display: false } }, interaction: { mode: 'index', intersect: false }, responsive: true },
      }),
      tempDetail: new Chart(document.getElementById("temp-detail-chart"), {
        type: "line",
        data: { labels: [], datasets: [{ label: "Temperature (°C)", data: [], borderColor: "#4CAF50", fill: false }] },
        options: { scales: { x: { type: "time", time: { unit: "minute" } }, y: { min: 0, max: 40 } }, plugins: { zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' } } }, responsive: true },
      }),
      humidDetail: new Chart(document.getElementById("humid-detail-chart"), {
        type: "line",
        data: { labels: [], datasets: [{ label: "Humidity (%)", data: [], borderColor: "#2196F3", fill: false }] },
        options: { scales: { x: { type: "time", time: { unit: "minute" } }, y: { min: 0, max: 100 } }, plugins: { zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' } } }, responsive: true },
      }),
      soilDetail: new Chart(document.getElementById("soil-detail-chart"), {
        type: "line",
        data: { labels: [], datasets: [{ label: "Soil Moisture (%)", data: [], borderColor: "#8D5524", fill: false }] },
        options: { scales: { x: { type: "time", time: { unit: "minute" } }, y: { min: 0, max: 100 } }, plugins: { zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' } } }, responsive: true },
      }),
      airDetail: new Chart(document.getElementById("air-detail-chart"), {
        type: "line",
        data: { labels: [], datasets: [{ label: "Air Quality (ppm)", data: [], borderColor: "#F44336", fill: false }] },
        options: { scales: { x: { type: "time", time: { unit: "minute" } }, y: { min: 0, max: 200 } }, plugins: { zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' } } }, responsive: true },
      }),
    };

    // ---- Map Initialization ----
    let cowMap;
    let cowMarkers = [];
    let cowPaths = {};
    let geofenceCircle;
    function initCowMap() {
      const settings = JSON.parse(localStorage.getItem("settings")) || {};
      const centerLat = parseFloat(settings.mapLat) || 51.505;
      const centerLng = parseFloat(settings.mapLng) || -0.09;
      cowMap = L.map('cow-map').setView([centerLat, centerLng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(cowMap);
      const radius = (parseFloat(settings.geofenceRadius) || 0.5) * 1000; // km to meters
      geofenceCircle = L.circle([centerLat, centerLng], { radius, color: '#ff7800', fillOpacity: 0.1 }).addTo(cowMap);
    }

    // ---- Data Storage ----
    const trends = { temp: [], humid: [], soil: [], air: [] };
    let thresholds = JSON.parse(localStorage.getItem("thresholds")) || {
      temp: { min: 15, max: 30 },
      humid: { min: 40, max: 80 },
      soil: { min: 30, max: 80 },
      air: { min: 50, max: 100 }
    };
    let logs = JSON.parse(localStorage.getItem("logs")) || [];
    let diagnosisHistory = JSON.parse(localStorage.getItem("diagnosisHistory")) || [];
    let notificationQueue = [];
    const MAX_NOTIFICATIONS = 3;
    let cows = JSON.parse(localStorage.getItem("cows")) || [
      { id: "Cow1", lat: 51.505, lng: -0.09, health: "healthy", path: [] },
      { id: "Cow2", lat: 51.51, lng: -0.08, health: "healthy", path: [] },
      { id: "Cow3", lat: 51.50, lng: -0.10, health: "healthy", path: [] }
    ];
    let pumps = JSON.parse(localStorage.getItem("pumps")) || [];
    let startTime = Date.now();
    let notificationCount = 0;

    // ---- Pump Management ----
    function addPump() {
      try {
        const name = document.getElementById("pump-name").value || `Pump ${pumps.length + 1}`;
        pumps.push({ name, isOn: false, timer: 0, intervalId: null });
        savePumps();
        renderPumps();
        togglePumpForm();
        addNotification(`${name} added successfully!`);
        logEvent(`Added pump: ${name}`);
      } catch (e) {
        addNotification(`Error adding pump: ${e.message}`, true);
        logEvent(`Error adding pump: ${e.message}`);
      }
    }

    function renderPumps() {
      const container = document.getElementById("pump-container");
      container.innerHTML = "";
      pumps.forEach((pump, index) => {
        const card = document.createElement("div");
        card.className = "pump-card";
        card.innerHTML = `
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800">${pump.name}</h3>
            <span class="status-dot ${pump.isOn ? 'bg-green-500' : 'bg-red-500'}"></span>
          </div>
          <p class="text-sm text-gray-600">Timer: <span id="timer-${index}">${pump.timer}s</span></p>
          <button onclick="togglePump(${index})" class="mt-2 p-2 rounded text-white ${pump.isOn ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}">
            ${pump.isOn ? "Turn Off" : "Turn On"}
          </button>
          <input id="timer-input-${index}" type="number" min="0" placeholder="Set timer (s)" class="mt-2 p-1 border rounded w-32" />
          <button onclick="setTimer(${index})" class="mt-2 ml-2 p-1 bg-blue-600 text-white rounded hover:bg-blue-700">Set</button>
          <button onclick="confirmDeletePump(${index})" class="mt-2 ml-2 p-1 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
        `;
        container.appendChild(card);
      });
    }

    function togglePump(index) {
      try {
        pumps[index].isOn = !pumps[index].isOn;
        if (!pumps[index].isOn && pumps[index].intervalId) {
          clearInterval(pumps[index].intervalId);
          pumps[index].intervalId = null;
        }
        addNotification(`${pumps[index].name} turned ${pumps[index].isOn ? "on" : "off"}.`);
        logEvent(`${pumps[index].name} turned ${pumps[index].isOn ? "on" : "off"}`);
        savePumps();
        renderPumps();
      } catch (e) {
        addNotification(`Error toggling pump: ${e.message}`, true);
        logEvent(`Error toggling pump: ${e.message}`);
      }
    }

    function setTimer(index) {
      try {
        const timer = parseInt(document.getElementById(`timer-input-${index}`).value) || 0;
        pumps[index].timer = timer;
        if (pumps[index].isOn && timer > 0) {
          if (pumps[index].intervalId) clearInterval(pumps[index].intervalId);
          pumps[index].intervalId = setInterval(() => {
            pumps[index].timer--;
            document.getElementById(`timer-${index}`).textContent = `${pumps[index].timer}s`;
            if (pumps[index].timer <= 0) {
              togglePump(index);
            }
          }, 1000);
        }
        savePumps();
        renderPumps();
      } catch (e) {
        addNotification(`Error setting timer: ${e.message}`, true);
        logEvent(`Error setting timer: ${e.message}`);
      }
    }

    function confirmDeletePump(index) {
      showModal(`Are you sure you want to delete ${pumps[index].name}?`, () => {
        deletePump(index);
      });
    }

    function deletePump(index) {
      try {
        const pumpName = pumps[index].name;
        if (pumps[index].intervalId) clearInterval(pumps[index].intervalId);
        pumps.splice(index, 1);
        savePumps();
        renderPumps();
        addNotification(`${pumpName} deleted successfully!`);
        logEvent(`Deleted pump: ${pumpName}`);
      } catch (e) {
        addNotification(`Error deleting pump: ${e.message}`, true);
        logEvent(`Error deleting pump: ${e.message}`);
      }
    }

    function togglePumpForm() {
      const form = document.getElementById("pump-form");
      form.classList.toggle("hidden");
      document.getElementById("pump-name").value = "";
    }

    function savePumps() {
      localStorage.setItem("pumps", JSON.stringify(pumps.map(p => ({ name: p.name, isOn: p.isOn, timer: p.timer }))));
    }

    // ---- AI Assistant ----
    function toggleAssistant() {
      const section = document.getElementById("assistant-section");
      section.classList.toggle("hidden");
    }

    const diseaseDatabase = [
      { name: "Powdery Mildew", symptoms: [{ text: "white spots", weight: 8 }, { text: "powdery coating", weight: 10 }, { text: "curled leaves", weight: 6 }], conditions: { humid: "high", temp: "moderate" }, remedy: "Improve air circulation, apply sulfur-based fungicide in 2 days.", severityImpact: { mild: 0.8, severe: 1.2 } },
      { name: "Root Rot", symptoms: [{ text: "wilting", weight: 7 }, { text: "yellow leaves", weight: 8 }, { text: "soft roots", weight: 10 }, { text: "stunted growth", weight: 5 }], conditions: { soil: "low", humid: "high" }, remedy: "Reduce watering immediately, improve drainage.", severityImpact: { mild: 0.7, severe: 1.3 } },
      { name: "Leaf Spot", symptoms: [{ text: "brown spots", weight: 9 }, { text: "yellow edges", weight: 7 }, { text: "leaf drop", weight: 6 }], conditions: { humid: "high", temp: "high" }, remedy: "Remove affected leaves now, apply copper fungicide in 3 days.", severityImpact: { mild: 0.9, severe: 1.1 } },
      { name: "Blight", symptoms: [{ text: "dark spots", weight: 8 }, { text: "wilting", weight: 7 }, { text: "rapid leaf death", weight: 10 }], conditions: { humid: "high", temp: "high" }, remedy: "Remove infected parts today, use copper-based fungicide tomorrow.", severityImpact: { mild: 0.8, severe: 1.4 } },
      { name: "Downy Mildew", symptoms: [{ text: "yellow patches", weight: 7 }, { text: "gray fuzz", weight: 9 }, { text: "leaf curl", weight: 6 }], conditions: { humid: "high", temp: "cool" }, remedy: "Increase spacing now, apply fungicide in 2 days.", severityImpact: { mild: 0.7, severe: 1.2 } },
      { name: "Fusarium Wilt", symptoms: [{ text: "wilting", weight: 8 }, { text: "yellowing veins", weight: 7 }, { text: "drooping", weight: 6 }], conditions: { temp: "high", soil: "low" }, remedy: "Remove infected plants immediately, improve soil health over 1 week.", severityImpact: { mild: 0.6, severe: 1.5 } },
      { name: "Rust", symptoms: [{ text: "orange spots", weight: 9 }, { text: "rusty patches", weight: 8 }, { text: "leaf yellowing", weight: 6 }], conditions: { humid: "moderate", temp: "moderate" }, remedy: "Remove affected leaves today, apply rust-specific fungicide in 3 days.", severityImpact: { mild: 0.9, severe: 1.1 } },
      { name: "Verticillium Wilt", symptoms: [{ text: "wilting", weight: 7 }, { text: "brown veins", weight: 8 }, { text: "leaf drop", weight: 6 }], conditions: { temp: "high", soil: "dry" }, remedy: "Rotate crops next season, remove infected plants now.", severityImpact: { mild: 0.7, severe: 1.3 } },
      { name: "Anthracnose", symptoms: [{ text: "black spots", weight: 9 }, { text: "sunken lesions", weight: 8 }, { text: "fruit rot", weight: 7 }], conditions: { humid: "high", temp: "warm" }, remedy: "Prune affected areas today, apply fungicide in 2 days.", severityImpact: { mild: 0.8, severe: 1.2 } },
      { name: "Botrytis (Gray Mold)", symptoms: [{ text: "gray mold", weight: 10 }, { text: "soft spots", weight: 8 }, { text: "wilting", weight: 6 }], conditions: { humid: "high", temp: "cool" }, remedy: "Improve ventilation now, remove infected parts tomorrow.", severityImpact: { mild: 0.7, severe: 1.3 } },
    ];

    function diagnosePlant() {
      try {
        const symptomsInput = document.getElementById("symptoms").value.toLowerCase().trim();
        if (!symptomsInput) {
          addNotification("Please describe the plant symptoms.", true);
          logEvent("AI Doctor: Empty symptoms input.");
          return;
        }

        const symptomWords = symptomsInput.split(/[\s,]+/);
        const severity = symptomsInput.includes("severe") ? "severe" : symptomsInput.includes("mild") ? "mild" : "moderate";
        const latestConditions = {
          temp: trends.temp.length ? trends.temp[trends.temp.length - 1] : 25,
          humid: trends.humid.length ? trends.humid[trends.humid.length - 1] : 50,
          soil: trends.soil.length ? trends.soil[trends.soil.length - 1] : 50,
        };
        const tempTrend = trends.temp.length > 10 ? (trends.temp[trends.temp.length - 1] - trends.temp[trends.temp.length - 10]) / 10 : 0;
        const humidTrend = trends.humid.length > 10 ? (trends.humid[trends.humid.length - 1] - trends.humid[trends.humid.length - 10]) / 10 : 0;

        let bestMatch = null;
        let highestScore = 0;

        diseaseDatabase.forEach(disease => {
          let score = 0;
          disease.symptoms.forEach(s => {
            if (symptomWords.some(w => s.text.includes(w))) score += s.weight;
          });

          if (disease.conditions.temp === "high" && latestConditions.temp > thresholds.temp.max) score += 5 + (tempTrend > 0 ? 2 : 0);
          if (disease.conditions.temp === "moderate" && latestConditions.temp >= thresholds.temp.min && latestConditions.temp <= thresholds.temp.max) score += 5;
          if (disease.conditions.temp === "cool" && latestConditions.temp < thresholds.temp.min) score += 5 + (tempTrend < 0 ? 2 : 0);
          if (disease.conditions.humid === "high" && latestConditions.humid > thresholds.humid.max) score += 5 + (humidTrend > 0 ? 2 : 0);
          if (disease.conditions.humid === "moderate" && latestConditions.humid >= thresholds.humid.min && latestConditions.humid <= thresholds.humid.max) score += 5;
          if (disease.conditions.soil === "low" && latestConditions.soil < thresholds.soil.min) score += 5;
          if (disease.conditions.soil === "dry" && latestConditions.soil < thresholds.soil.min * 1.2) score += 5;

          const severityFactor = disease.severityImpact ? disease.severityImpact[severity] || 1 : 1;
          score *= severityFactor;

          if (score > highestScore) {
            highestScore = score;
            bestMatch = disease;
          }
        });

        let diagnosis = "No matching disease found based on symptoms and conditions.";
        if (bestMatch && highestScore >= 15) {
          diagnosis = `Possible Disease: ${bestMatch.name}\nMatching Symptoms: ${bestMatch.symptoms.filter(s => symptomWords.some(w => s.text.includes(w))).map(s => s.text).join(", ")}\nRemedy: ${bestMatch.remedy}\nConfidence: ${Math.min(100, Math.round(highestScore))}%\nSeverity: ${severity}`;
        }

        addNotification(`AI Plant Doctor Diagnosis:\n${diagnosis}`, true);
        logEvent(`AI Doctor Diagnosis: ${diagnosis.split('\n')[0]}`);
        diagnosisHistory.push({ date: new Date().toLocaleString(), symptoms: symptomsInput, diagnosis });
        saveDiagnosisHistory();
        updateDiagnosisHistory();
        document.getElementById("symptoms").value = "";
      } catch (e) {
        addNotification(`Error diagnosing plant: ${e.message}`, true);
        logEvent(`Error diagnosing plant: ${e.message}`);
      }
    }

    function updateDiagnosisHistory() {
      const historyDiv = document.getElementById("diagnosis-history");
      historyDiv.innerHTML = diagnosisHistory.map(h => `<p class="border-b py-1">${h.date}: ${h.symptoms} -> ${h.diagnosis.split('\n')[0]}</p>`).join("");
    }

    function saveDiagnosisHistory() {
      localStorage.setItem("diagnosisHistory", JSON.stringify(diagnosisHistory));
    }

    // ---- Notifications ----
    function addNotification(message, isCritical = false) {
      notificationCount++;
      notificationQueue.push({ message, isCritical });
      renderNotifications();
      updatePerformance();
    }

    function renderNotifications() {
      const notificationsDiv = document.getElementById("notifications");
      const criticalOnly = document.getElementById("critical-only").checked;
      let filteredQueue = criticalOnly ? notificationQueue.filter(n => n.isCritical) : notificationQueue;
      while (notificationsDiv.children.length > 0) {
        notificationsDiv.removeChild(notificationsDiv.firstChild);
      }
      filteredQueue.slice(-MAX_NOTIFICATIONS).forEach(n => {
        const div = document.createElement("div");
        div.className = "notification";
        div.innerHTML = `<p>${n.message.replace(/\n/g, "<br>")}</p><button onclick="this.parentElement.remove(); removeNotification('${n.message}')" class="text-red-500 text-sm">Dismiss</button>`;
        notificationsDiv.appendChild(div);
      });
    }

    function removeNotification(message) {
      notificationQueue = notificationQueue.filter(n => n.message !== message);
      renderNotifications();
    }

    function filterNotifications() {
      renderNotifications();
    }

    // ---- Location ----
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          document.getElementById("location").textContent = `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`;
          logEvent(`Location fetched: ${latitude.toFixed(2)}, ${longitude.toFixed(2)}`);
          if (!cowMap) {
            document.getElementById("map-lat").value = latitude;
            document.getElementById("map-lng").value = longitude;
            saveSettings();
          }
        },
        () => {
          document.getElementById("location").textContent = "Unavailable";
          logEvent("Location unavailable");
        }
      );
    }

    // ---- AI Functions ----
    function updateThresholds(sensor, data) {
      const avg = data.reduce((sum, val) => sum + val, 0) / data.length;
      thresholds[sensor].min = Math.max(0, avg * 0.8);
      thresholds[sensor].max = Math.min(charts[sensor].options.scales.y.max, avg * 1.2);
    }

    function detectAnomaly(sensor, value, data) {
      if (data.length < 5) return false;
      const lastFew = data.slice(-5);
      const avg = lastFew.reduce((sum, val) => sum + val, 0) / lastFew.length;
      const deviation = Math.abs(value - avg) / avg;
      return deviation > 0.3;
    }

    function predictIrrigation(soilData) {
      if (soilData.length < 5) return false;
      const trend = soilData.slice(-5).reduce((acc, val, i, arr) => acc + (i > 0 ? val - arr[i - 1] : 0), 0) / 4;
      const current = soilData[soilData.length - 1];
      return current < thresholds.soil.min && trend < 0;
    }

    // ---- Cow Tracking ----
    function updateCowLocations() {
      const settings = JSON.parse(localStorage.getItem("settings")) || {};
      const centerLat = parseFloat(settings.mapLat) || 51.505;
      const centerLng = parseFloat(settings.mapLng) || -0.09;
      const radius = (parseFloat(settings.geofenceRadius) || 0.5) * 1000;

      cows.forEach(cow => {
        cow.lat += (Math.random() - 0.5) * 0.001;
        cow.lng += (Math.random() - 0.5) * 0.001;
        cow.path.push([cow.lat, cow.lng]);
        if (cow.path.length > 50) cow.path.shift();

        const distance = L.latLng(cow.lat, cow.lng).distanceTo([centerLat, centerLng]);
        if (distance > radius) {
          addNotification(`${cow.id} has left the geofence (${distance.toFixed(0)}m away)!`, true);
          logEvent(`${cow.id} left geofence`);
        }
      });
      saveCows();
      renderCowMap();
    }

    function renderCowMap() {
      if (!cowMap) return;
      cowMarkers.forEach(m => cowMap.removeLayer(m));
      Object.values(cowPaths).forEach(p => cowMap.removeLayer(p));
      cowMarkers = [];
      cowPaths = {};

      cows.forEach(cow => {
        const marker = L.marker([cow.lat, cow.lng]).addTo(cowMap)
          .bindPopup(`<b>${cow.id}</b><br>Lat: ${cow.lat.toFixed(4)}, Lng: ${cow.lng.toFixed(4)}<br>Health: ${cow.health}`);
        cowMarkers.push(marker);
        if (cow.path.length > 1) {
          cowPaths[cow.id] = L.polyline(cow.path, { color: '#3388ff' }).addTo(cowMap);
        }
      });

      const cowList = document.getElementById("cow-list-items");
      cowList.innerHTML = cows.map(cow => `<li class="flex justify-between"><span>${cow.id}: Lat ${cow.lat.toFixed(4)}, Lng ${cow.lng.toFixed(4)}, Health: ${cow.health}</span><button onclick="selectCow('${cow.id}')" class="text-blue-500 text-sm">Edit</button></li>`).join("");
      updatePerformance();
    }

    function addCow() {
      try {
        const id = document.getElementById("cow-id").value.trim();
        const lat = parseFloat(document.getElementById("cow-lat").value);
        const lng = parseFloat(document.getElementById("cow-lng").value);
        const health = document.getElementById("cow-health").value;
        if (!id || isNaN(lat) || isNaN(lng)) {
          addNotification("Please provide valid cow ID, latitude, and longitude.", true);
          return;
        }
        if (cows.some(c => c.id === id)) {
          addNotification(`Cow ${id} already exists.`, true);
          return;
        }
        cows.push({ id, lat, lng, health, path: [] });
        saveCows();
        renderCowMap();
        addNotification(`${id} added successfully!`);
        logEvent(`Added cow: ${id}`);
        clearCowForm();
      } catch (e) {
        addNotification(`Error adding cow: ${e.message}`, true);
        logEvent(`Error adding cow: ${e.message}`);
      }
    }

    function selectCow(id) {
      const cow = cows.find(c => c.id === id);
      if (cow) {
        document.getElementById("cow-id").value = cow.id;
        document.getElementById("cow-lat").value = cow.lat;
        document.getElementById("cow-lng").value = cow.lng;
        document.getElementById("cow-health").value = cow.health;
      }
    }

    function deleteSelectedCow() {
      const id = document.getElementById("cow-id").value.trim();
      if (!id || !cows.some(c => c.id === id)) {
        addNotification("Please select a valid cow to delete.", true);
        return;
      }
      showModal(`Are you sure you want to delete ${id}?`, () => {
        cows = cows.filter(c => c.id !== id);
        saveCows();
        renderCowMap();
        addNotification(`${id} deleted successfully!`);
        logEvent(`Deleted cow: ${id}`);
        clearCowForm();
      });
    }

    function clearCowForm() {
      document.getElementById("cow-id").value = "";
      document.getElementById("cow-lat").value = "";
      document.getElementById("cow-lng").value = "";
      document.getElementById("cow-health").value = "healthy";
    }

    function saveCows() {
      localStorage.setItem("cows", JSON.stringify(cows));
    }

    // ---- Section Management ----
    function showSection(sectionId) {
      const sections = document.querySelectorAll(".section");
      sections.forEach(s => s.classList.add("hidden"));
      document.getElementById(`${sectionId}-section`).classList.remove("hidden");
      document.getElementById("section-title").textContent = sectionId.charAt(0).toUpperCase() + sectionId.slice(1).replace(/-/g, " ") + " Overview";
      if (sectionId === "cow-tracking" && !cowMap) {
        initCowMap();
        renderCowMap();
      }
      if (sectionId === "performance") updatePerformance();
    }

    // ---- Logs ----
    function logEvent(message) {
      logs.push({ date: new Date().toLocaleString(), message });
      saveLogs();
      updateLogs();
    }

    function updateLogs() {
      const logContainer = document.getElementById("log-container");
      logContainer.innerHTML = logs.map(l => `<div class="log-entry">${l.date}: ${l.message}</div>`).join("");
    }

    function saveLogs() {
      localStorage.setItem("logs", JSON.stringify(logs));
    }

    function exportLogs() {
      try {
        const logText = logs.map(l => `${l.date},${l.message}`).join("\n");
        const blob = new Blob(["Date,Message\n" + logText], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "agri_dashboard_logs.csv";
        link.click();
        logEvent("Logs exported");
      } catch (e) {
        addNotification(`Error exporting logs: ${e.message}`, true);
        logEvent(`Error exporting logs: ${e.message}`);
      }
    }

    // ---- Settings ----
    function saveSettings() {
      try {
        thresholds.temp.min = parseFloat(document.getElementById("temp-min").value);
        thresholds.temp.max = parseFloat(document.getElementById("temp-max").value);
        thresholds.humid.min = parseFloat(document.getElementById("humid-min").value);
        thresholds.humid.max = parseFloat(document.getElementById("humid-max").value);
        thresholds.soil.min = parseFloat(document.getElementById("soil-min").value);
        thresholds.soil.max = parseFloat(document.getElementById("soil-max").value);
        thresholds.air.min = parseFloat(document.getElementById("air-min").value);
        thresholds.air.max = parseFloat(document.getElementById("air-max").value);
        const settings = {
          mapLat: document.getElementById("map-lat").value,
          mapLng: document.getElementById("map-lng").value,
          geofenceRadius: document.getElementById("geofence-radius").value
        };
        localStorage.setItem("thresholds", JSON.stringify(thresholds));
        localStorage.setItem("settings", JSON.stringify(settings));
        if (cowMap) {
          cowMap.setView([parseFloat(settings.mapLat), parseFloat(settings.mapLng)], 13);
          geofenceCircle.setLatLng([parseFloat(settings.mapLat), parseFloat(settings.mapLng)]);
          geofenceCircle.setRadius(parseFloat(settings.geofenceRadius) * 1000);
        }
        addNotification("Settings saved successfully!");
        logEvent("Settings updated");
      } catch (e) {
        addNotification(`Error saving settings: ${e.message}`, true);
        logEvent(`Error saving settings: ${e.message}`);
      }
    }

    // ---- Modal ----
    function showModal(message, onConfirm) {
      document.getElementById("confirm-message").textContent = message;
      document.getElementById("confirm-yes").onclick = () => {
        onConfirm();
        hideModal();
      };
      document.getElementById("confirm-modal").style.display = "flex";
    }

    function hideModal() {
      document.getElementById("confirm-modal").style.display = "none";
    }

    // ---- Dark Mode ----
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
    }

    if (localStorage.getItem("darkMode") === "true") {
      document.body.classList.add("dark-mode");
    }

    // ---- Data Export ----
    function exportChartData(chartId) {
      try {
        const chart = charts[chartId];
        const data = chart.data.labels.map((label, i) => `${label.toISOString()},${chart.data.datasets[0].data[i]}`);
        const blob = new Blob([`Timestamp,${chart.data.datasets[0].label}\n` + data.join("\n")], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${chartId}_data.csv`;
        link.click();
        logEvent(`Exported ${chartId} data`);
      } catch (e) {
        addNotification(`Error exporting chart data: ${e.message}`, true);
        logEvent(`Error exporting chart data: ${e.message}`);
      }
    }

    function exportAllData() {
      try {
        const allData = {
          sensors: {
            temp: charts.tempDetail.data.labels.map((l, i) => ({ time: l.toISOString(), value: charts.tempDetail.data.datasets[0].data[i] })),
            humid: charts.humidDetail.data.labels.map((l, i) => ({ time: l.toISOString(), value: charts.humidDetail.data.datasets[0].data[i] })),
            soil: charts.soilDetail.data.labels.map((l, i) => ({ time: l.toISOString(), value: charts.soilDetail.data.datasets[0].data[i] })),
            air: charts.airDetail.data.labels.map((l, i) => ({ time: l.toISOString(), value: charts.airDetail.data.datasets[0].data[i] }))
          },
          cows,
          pumps,
          diagnosisHistory,
          logs
        };
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "agri_dashboard_all_data.json";
        link.click();
        logEvent("Exported all data");
      } catch (e) {
        addNotification(`Error exporting all data: ${e.message}`, true);
        logEvent(`Error exporting all data: ${e.message}`);
      }
    }

    // ---- Performance ----
    function updatePerformance() {
      const uptimeSeconds = Math.floor((Date.now() - startTime) / 1000);
      document.getElementById("uptime").textContent = `${uptimeSeconds}s`;
      document.getElementById("memory-usage").textContent = `${Math.round(Math.random() * 10 + 20)} MB`; // Simulated
      document.getElementById("notification-count").textContent = notificationCount;
      document.getElementById("cow-count").textContent = cows.length;
    }

    // ---- Simulated ESP32 Data ----
    function simulateSensorData() {
      try {
        const now = new Date();
        const temp = Math.random() * (35 - 15) + 15;
        const humid = Math.random() * (90 - 30) + 30;
        const soil = Math.random() * (80 - 20) + 20;
        const air = Math.random() * (150 - 50) + 50;

        trends.temp.push(temp);
        trends.humid.push(humid);
        trends.soil.push(soil);
        trends.air.push(air);
        if (trends.temp.length > 50) {
          trends.temp.shift();
          trends.humid.shift();
          trends.soil.shift();
          trends.air.shift();
        }

        updateThresholds("temp", trends.temp);
        updateThresholds("humid", trends.humid);
        updateThresholds("soil", trends.soil);
        updateThresholds("air", trends.air);

        document.getElementById("temp-value").textContent = temp.toFixed(1) + " °C";
        document.getElementById("temp-status").style.backgroundColor = temp > thresholds.temp.max ? "#F44336" : temp < thresholds.temp.min ? "#FF9800" : "#4CAF50";
        if (temp > thresholds.temp.max) addNotification("High temperature detected!", true);
        if (detectAnomaly("temp", temp, trends.temp)) addNotification("Temperature anomaly detected!", true);
        charts.temp.data.labels.push(now);
        charts.temp.data.datasets[0].data.push(temp);
        if (charts.temp.data.labels.length > 20) {
          charts.temp.data.labels.shift();
          charts.temp.data.datasets[0].data.shift();
        }
        charts.temp.update();

        document.getElementById("humid-value").textContent = humid.toFixed(1) + " %";
        document.getElementById("humid-status").style.backgroundColor = humid > thresholds.humid.max ? "#F44336" : humid < thresholds.humid.min ? "#FF9800" : "#4CAF50";
        if (humid > thresholds.humid.max) addNotification("High humidity detected!", true);
        if (detectAnomaly("humid", humid, trends.humid)) addNotification("Humidity anomaly detected!", true);
        charts.humid.data.labels.push(now);
        charts.humid.data.datasets[0].data.push(humid);
        if (charts.humid.data.labels.length > 20) {
          charts.humid.data.labels.shift();
          charts.humid.data.datasets[0].data.shift();
        }
        charts.humid.update();

        document.getElementById("soil-value").textContent = soil.toFixed(1) + " %";
        document.getElementById("soil-status").style.backgroundColor = soil < thresholds.soil.min ? "#F44336" : soil < thresholds.soil.min * 1.2 ? "#FF9800" : "#4CAF50";
        if (soil < thresholds.soil.min) addNotification("Low soil moisture detected!", true);
        if (predictIrrigation(trends.soil) && pumps.length > 0 && !pumps.some(p => p.isOn)) {
          addNotification(`AI Suggestion: Turn on ${pumps[0].name} due to low soil moisture trend.`, true);
        }
        if (detectAnomaly("soil", soil, trends.soil)) addNotification("Soil moisture anomaly detected!", true);
        charts.soil.data.labels.push(now);
        charts.soil.data.datasets[0].data.push(soil);
        if (charts.soil.data.labels.length > 20) {
          charts.soil.data.labels.shift();
          charts.soil.data.datasets[0].data.shift();
        }
        charts.soil.update();

        document.getElementById("air-value").textContent = air.toFixed(1) + " ppm";
        document.getElementById("air-status").style.backgroundColor = air > thresholds.air.max ? "#F44336" : air > thresholds.air.max * 0.8 ? "#FF9800" : "#4CAF50";
        if (air > thresholds.air.max) addNotification("Poor air quality detected!", true);
        if (detectAnomaly("air", air, trends.air)) addNotification("Air quality anomaly detected!", true);
        charts.air.data.labels.push(now);
        charts.air.data.datasets[0].data.push(air);
        if (charts.air.data.labels.length > 20) {
          charts.air.data.labels.shift();
          charts.air.data.datasets[0].data.shift();
        }
        charts.air.update();

        charts.tempDetail.data.labels.push(now);
        charts.tempDetail.data.datasets[0].data.push(temp);
        if (charts.tempDetail.data.labels.length > 50) {
          charts.tempDetail.data.labels.shift();
          charts.tempDetail.data.datasets[0].data.shift();
        }
        charts.tempDetail.update();

        charts.humidDetail.data.labels.push(now);
        charts.humidDetail.data.datasets[0].data.push(humid);
        if (charts.humidDetail.data.labels.length > 50) {
          charts.humidDetail.data.labels.shift();
          charts.humidDetail.data.datasets[0].data.shift();
        }
        charts.humidDetail.update();

        charts.soilDetail.data.labels.push(now);
        charts.soilDetail.data.datasets[0].data.push(soil);
        if (charts.soilDetail.data.labels.length > 50) {
          charts.soilDetail.data.labels.shift();
          charts.soilDetail.data.datasets[0].data.shift();
        }
        charts.soilDetail.update();

        charts.airDetail.data.labels.push(now);
        charts.airDetail.data.datasets[0].data.push(air);
        if (charts.airDetail.data.labels.length > 50) {
          charts.airDetail.data.labels.shift();
          charts.airDetail.data.datasets[0].data.shift();
        }
        charts.airDetail.update();

        const rainChance = Math.random();
        const rainDetected = rainChance >= 0.3;
        document.getElementById("rain-alert").classList.toggle("hidden", !rainDetected);
        if (rainDetected) {
          addNotification("Rain detected! Turning off all pumps.", true);
          pumps.forEach((pump, index) => {
            if (pump.isOn) togglePump(index);
          });
          logEvent("Rain detected, pumps turned off");
        }

        updateCowLocations();
        document.getElementById("current-time").textContent = now.toLocaleString();
      } catch (e) {
        addNotification(`Error in sensor data simulation: ${e.message}`, true);
        logEvent(`Error in sensor data simulation: ${e.message}`);
      }
    }

    // ---- Main Loop ----
    setInterval(simulateSensorData, 2000);
    simulateSensorData();
    showSection("home");
    renderPumps();
    updateDiagnosisHistory();
    updateLogs();

    // ---- Initial Settings Load ----
    const settings = JSON.parse(localStorage.getItem("settings")) || {};
    document.getElementById("temp-min").value = thresholds.temp.min;
    document.getElementById("temp-max").value = thresholds.temp.max;
    document.getElementById("humid-min").value = thresholds.humid.min;
    document.getElementById("humid-max").value = thresholds.humid.max;
    document.getElementById("soil-min").value = thresholds.soil.min;
    document.getElementById("soil-max").value = thresholds.soil.max;
    document.getElementById("air-min").value = thresholds.air.min;
    document.getElementById("air-max").value = thresholds.air.max;
    document.getElementById("map-lat").value = settings.mapLat || 51.505;
    document.getElementById("map-lng").value = settings.mapLng || -0.09;
    document.getElementById("geofence-radius").value = settings.geofenceRadius || 0.5;
  </script>
</body>
</html>